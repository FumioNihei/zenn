---
title: "pytorch, BERT, batchå‡¦ç†, paddingã™ã‚‹ã¨ã—ãªã„æ™‚ã¨ã¯å€¤ãŒç•°ãªã‚‹"
emoji: "ğŸ§¯"
type: "tech"
topics: [pytorch,python,huggingface,BERT]
published: true
published_at: 2023-11-04 03:36
---

# å›ç­”ï¼šæ°—ã®ã›ã„ã§ã™ï¼

æ­£ç¢ºã«ã¯ï¼Œèª¤å·®ã®ç¯„å›²ï¼Œã§è‰¯ã„ã¨æ€ã„ã¾ã™ï¼

ä»¥é™ã‚ˆã‚Šç´°ã‹ã„æ¤œè¨¼ã®è©±ã§ã™ï¼


# ç’°å¢ƒæƒ…å ±
- OS: win 10
- pytorch==2.10


# ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã§CLSã®å€¤ã‚’å–ã‚Šå‡ºã—ã¾ã™

```python
from transformers import BertJapaneseTokenizer, BertModel
model_name = 'cl-tohoku/bert-base-japanese-whole-word-masking'

tokenizer = BertJapaneseTokenizer.from_pretrained( model_name )
pt_model = BertModel.from_pretrained( model_name )
pt_model.eval()


def encoding( text ) -> np.array:
    tokenized = tokenizer( text, padding=True, return_tensors="pt" )
    batched_ids = tokenized.input_ids
    mask = tokenized.attention_mask
    
    print( "***********************" )
    print( f"batched_ids: {batched_ids}" ) # å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆãŒã©ã®ç•ªå·ã«tokenizeã•ã‚ŒãŸã‹ã®ç¢ºèª
    print( f"mask: {mask}" )ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€# å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆã®ã©ã“ãŒmaskã•ã‚Œã¦ã„ã‚‹ã‹ã®ç¢ºèª
    print( "***********************" )

    with torch.no_grad():
        outputs = pt_model( batched_ids, attention_mask=mask )

    last_hidden_states = outputs[0]
    cls = last_hidden_states[ :, 0, : ]
    return cls.numpy()
```

# ã¾ãšã¯åŒã˜æ–‡ã‚’BERTã«ä¸ãˆã¦ï¼Œãã‚Œã‚‰ã®CLSã®å€¤ãŒä¸€è‡´ã™ã‚‹ã‹ã‚’ç¢ºã‹ã‚ã¾ã™

```python
e1 = encoding( "ã“ã‚“ã«ã¡ã¯" )
e2 = encoding( "ã“ã‚“ã«ã¡ã¯" )
print( f"shapes: {e1.shape}, {e2.shape}" )
print( e1[0, :30] ) # embeddingã®å…ˆé ­30è¦ç´ ã®å€¤ã‚’ç¢ºèªã—ã¦ãŠãã¾ã™ï¼å¿µã®ãŸã‚ï¼
print( e2[0, :30] )
print( f"matched?: {(e1[0, :] == e2[0, :]).all()}" ) # e1ã¨e2ã®è¦ç´ ã®å€¤ãŒåŒã˜ãªã‚‰True, ãã†ã§ãªã‘ã‚Œã°False.

# ä»¥ä¸‹å®Ÿè¡Œçµæœ
***********************
batched_ids: tensor([[    2, 10350, 25746, 28450,     3]])
mask: tensor([[1, 1, 1, 1, 1]])
***********************
***********************
batched_ids: tensor([[    2, 10350, 25746, 28450,     3]])
mask: tensor([[1, 1, 1, 1, 1]])
***********************
shapes: (1, 768), (1, 768)
[-0.12317186 -0.29084066  0.13944848  0.15317392 -0.21099006  0.24076676
 -0.27982163 -0.27193725 -0.33552122  0.1790561  -0.38695636  0.19878092
  0.08561726 -0.11280812  0.6676775  -0.2985249  -0.52726907  0.75172484
  0.35113254  0.22260407 -0.1364403   0.52606434 -1.0147591   0.10886844
 -0.19263619 -0.25389215 -0.10554688 -0.04117253  0.18171763  0.28062537]
[-0.12317186 -0.29084066  0.13944848  0.15317392 -0.21099006  0.24076676
 -0.27982163 -0.27193725 -0.33552122  0.1790561  -0.38695636  0.19878092
  0.08561726 -0.11280812  0.6676775  -0.2985249  -0.52726907  0.75172484
  0.35113254  0.22260407 -0.1364403   0.52606434 -1.0147591   0.10886844
 -0.19263619 -0.25389215 -0.10554688 -0.04117253  0.18171763  0.28062537]
matched?: True
```

e1ã¨e2ã¯å®Œå…¨ã«åŒã˜ã‚‚ã®ã§ã™ï¼`matched?: True`ãªãŸã‚ï¼ŒäºŒã¤ã®ãƒªã‚¹ãƒˆãŒæ ¼ç´ã—ã¦ã„ã‚‹å€¤ã¯å…¨ã¦å®Œå…¨ã«åŒã˜ã‚‚ã®ã§ã™ï¼


# paddingã™ã‚‹ã¨ã©ã†ãªã‚‹ã‹ç¢ºã‹ã‚ã‚‹ï¼šæ¡ä»¶1

```python
e1 = encoding( "ã“ã‚“ã«ã¡ã¯" )
e2 = encoding( ["ã“ã‚“ã«ã¡ã¯", "çŒ«"] )
print( f"shapes: {e1.shape}, {e2.shape}" )
print( e1[0, :30] ) # [0, :30]ã¯ï¼Œ0ç•ªç›®ã®æ–‡ï¼ˆã“ã‚“ã«ã¡ã¯ï¼‰ã®embeddingã®å…ˆé ­30è¦ç´ ï¼Œã‚’æ„å‘³ã™ã‚‹
print( e2[0, :30] ) # åŒä¸Š
print( f"matched?: {(e1[0, :] == e2[0, :]).all()}" )

# ä»¥ä¸‹å®Ÿè¡Œçµæœ
***********************
batched_ids: tensor([[    2, 10350, 25746, 28450,     3]])
mask: tensor([[1, 1, 1, 1, 1]])
***********************
***********************
batched_ids: tensor([[    2, 10350, 25746, 28450,     3],
                     [    2,  6040,     3,     0,     0]]) # <- æ–‡ã€ŒçŒ«ã€ãŒãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã•ã‚ŒãŸï¼ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ãƒˆãƒ¼ã‚¯ãƒ³ã¯0ï¼
mask: tensor([[1, 1, 1, 1, 1],
              [1, 1, 1, 0, 0]]) # <- 0 ã¯ãƒã‚¹ã‚¯ã•ã‚ŒãŸç®‡æ‰€ï¼
***********************
shapes: (1, 768), (2, 768) # <- e2ã«ã¯2æ–‡å…¥åŠ›ã—ãŸã®ã§ï¼Œshape=(2, 768)
[-0.12317186 -0.29084066  0.13944848  0.15317392 -0.21099006  0.24076676
 -0.27982163 -0.27193725 -0.33552122  0.1790561  -0.38695636  0.19878092
  0.08561726 -0.11280812  0.6676775  -0.2985249  -0.52726907  0.75172484
  0.35113254  0.22260407 -0.1364403   0.52606434 -1.0147591   0.10886844
 -0.19263619 -0.25389215 -0.10554688 -0.04117253  0.18171763  0.28062537]
[-0.12317186 -0.29084066  0.13944848  0.15317392 -0.21099006  0.24076676
 -0.27982163 -0.27193725 -0.33552122  0.1790561  -0.38695636  0.19878092
  0.08561726 -0.11280812  0.6676775  -0.2985249  -0.52726907  0.75172484
  0.35113254  0.22260407 -0.1364403   0.52606434 -1.0147591   0.10886844
 -0.19263619 -0.25389215 -0.10554688 -0.04117253  0.18171763  0.28062537]
matched?: True
```

e2ã¯äºŒã¤ã®å…¥åŠ›æ–‡ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰çµæœã«ãªã£ã¦ã„ã¾ã™ï¼e2ã®äºŒã¤ã‚ã®æ–‡`çŒ«`ã¯ï¼Œä¸€ã¤ã‚ã®æ–‡`ã“ã‚“ã«ã¡ã¯`ã‚ˆã‚Šãƒˆãƒ¼ã‚¯ãƒ³æ•°ãŒå°‘ãªã„ãŸã‚ï¼Œé©å½“ã«paddingã•ã‚ŒãŸã“ã¨ãŒä¸Šè¨˜ã®è¡¨ç¤ºã‹ã‚‰ç¢ºèªã§ãã¾ã™ï¼

ç¾æ™‚ç‚¹ã§ã¯ï¼Œe1ã®`ã“ã‚“ã«ã¡ã¯`ã®embeddingã¨e2ã®`ã“ã‚“ã«ã¡ã¯`ã®embeddingã¯åŒã˜ã‚‚ã®ã§ã™ï¼

# paddingã™ã‚‹ã¨ã©ã†ãªã‚‹ã‹ç¢ºã‹ã‚ã‚‹ï¼šæ¡ä»¶2

```python
e1 = encoding( "ã“ã‚“ã«ã¡ã¯" )
e2 = encoding( ["ã“ã‚“ã«ã¡ã¯", "ä»Šæ—¥ã®æ™©å¾¡é£¯ã¯å”æšã’ã®äºˆå®šã§ã™"] )
print( f"shapes: {e1.shape}, {e2.shape}" )
print( e1[0, :30] )
print( e2[0, :30] )
print( f"matched?: {(e1[0, :] == e2[0, :]).all()}" )

# ä»¥ä¸‹å®Ÿè¡Œçµæœ
***********************
batched_ids: tensor([[    2, 10350, 25746, 28450,     3]])
mask: tensor([[1, 1, 1, 1, 1]])
***********************
***********************
batched_ids: tensor([[    2, 10350, 25746, 28450,     3,     0,     0,     0,     0,     0,     0,     0,     0], # <- æ–‡ã€Œã“ã‚“ã«ã¡ã¯ã€ãŒãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã•ã‚ŒãŸï¼
                     [    2,  3246,     5,  4423,  1351, 29916,     9,  3425, 14702,     5,  1484,  2992,     3]])
mask: tensor([[1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0],
              [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]])
***********************
shapes: (1, 768), (2, 768)
[-0.12317186 -0.29084066  0.13944848  0.15317392 -0.21099006  0.24076676
 -0.27982163 -0.27193725 -0.33552122  0.1790561  -0.38695636  0.19878092
  0.08561726 -0.11280812  0.6676775  -0.2985249  -0.52726907  0.75172484
  0.35113254  0.22260407 -0.1364403   0.52606434 -1.0147591   0.10886844
 -0.19263619 -0.25389215 -0.10554688 -0.04117253  0.18171763  0.28062537]
[-0.1231717  -0.29084083  0.13944837  0.1531737  -0.21098952  0.24076748
 -0.27982208 -0.2719369  -0.33552155  0.17905572 -0.38695666  0.19878091
  0.08561811 -0.1128076   0.66767853 -0.2985254  -0.52726924  0.7517249
  0.35113272  0.22260398 -0.13643995  0.5260654  -1.0147597   0.10886877
 -0.19263577 -0.25389168 -0.10554667 -0.04117169  0.18171719  0.28062564]
matched?: False
```

ã“ã®æ¡ä»¶ã§ã¯e2ã®äºŒæ–‡ã®ã†ã¡ï¼Œä¸€ã¤ã‚ã®æ–‡`ã“ã‚“ã«ã¡ã¯`ã«ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ãŒã‹ã‹ã‚‹ã‚ˆã†ã«ï¼ŒäºŒã¤ã‚ã®æ–‡ã‚’é•·ãã—ã¾ã—ãŸï¼æ„å›³ã—ãŸé€šã‚Šã«æ–‡`ã“ã‚“ã«ã¡ã¯`ã«ã¯ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ãŒã‹ã‹ã‚Šã¾ã—ãŸï¼

ãã“ã§ã¾ãš`matched?`ã®è¡¨ç¤ºã‚’è¦‹ã‚‹ã¨ï¼Œ`False`ã§ã™ï¼ã™ãªã‚ã¡e1ã®`ã“ã‚“ã«ã¡ã¯`ã¨e2ã®`ã“ã‚“ã«ã¡ã¯`ã¯å®Œå…¨ã«åŒã˜ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ã—ã‹ã—embeddingã®å€¤ã‚’ç¢ºèªã™ã‚‹ã¨ï¼Œe1ã®å…ˆé ­3ã¤ã¯`-0.12317186 -0.29084066  0.13944848`ã§ã‚ã‚Šï¼Œe2ã¯`-0.1231717  -0.29084083  0.13944837`ã§ã™ï¼ãã‚Œãã‚Œå…ˆé ­ã‹ã‚‰ï¼Œ-0.123171, -0.290840, 0.139448ã¨ï¼Œå°æ•°ç‚¹ä»¥ä¸‹6æ¡ã¾ã§ã¯ä¸€è‡´ã—ã¦ã„ã‚‹ã‚ˆã†ã§ã™ï¼

ã™ãªã‚ã¡ã“ã®çµæœã¯ï¼Œãƒãƒƒãƒå‡¦ç†ã®ãŸã‚ã«æ–‡ã‚’paddingã™ã‚‹ã¨ï¼Œè¬ã®è¨ˆç®—èª¤å·®ãŒç”Ÿã˜ã¦ï¼Œpaddingã—ãªã„å ´åˆã¨ã¯å€¤ãŒå®Œå…¨ã«åŒã˜ã«ã¯ãªã‚‰ãªã„ï¼Œã“ã¨ã‚’ç¤ºå”†ã—ã¦ã„ã¾ã™ï¼ã¨ã„ã£ã¦ã‚‚ï¼Œå°æ•°ç‚¹ä»¥ä¸‹6æ¡ã¾ã§ã¯ä¸€è‡´ã—ã¦ã„ã‚‹ã®ã§ï¼Œã‚ã¾ã‚Šæ°—ã«ã™ã‚‹ã“ã¨ã¯ç„¡ã„ã¨æ€ã„ã¾ã™ï¼

å¾“ã£ã¦ï¼Œæ°—ã®ã›ã„ï¼Œã§æ¸ˆã¾ã›ã¾ã—ã‚‡ã†ï¼

# ãŠã‚ã‚Šã«
ã‚„ã‚Šæ–¹é–“é•ã£ã¦ã‚‹ã‚ˆï½ï¼Œã¨ã„ã†å ´åˆã¯æ•™ãˆã¦ãã ã•ã„ï¼